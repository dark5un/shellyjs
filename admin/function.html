<html>
<head>
<title>Raw function editor</title>
    <script src="/static/js/jquery-1.7.1.min.js"></script>
    <script src="/static/js/jquery.cookie.js"></script>
    <script src="/static/js/ba-debug.js"></script>

    <link rel="stylesheet" type="text/css" href="/static/jsoneditor-2.0.0/jsoneditor.css">
    <script type="text/javascript" src="/static/jsoneditor-2.0.0/jsoneditor.js"></script>
    <style type="text/css">
        #inputEditor {
            width: 300px;
            height: 400px;
            float: left;
        }
        #outputEditor {
            width: 500px;
            height: 400px;
            float:right;
        }
        body {
            font-family:verdana,arial,sans-serif;
            font-size:10pt;
            margin:30px;
        }
        .nameCell {
            font-weight: bold;
            width: 100px;
        }
    </style>
    <script language="javascript">
        var Env = {};
        Env = {{{params}});

        function formatJson(val) {
            val = val.replace(/(\n|\t)/gm, '');	// strip all newlines first

            var retval = '';
            var str = val;
            var pos = 0;
            var strLen = str.length;
            var indentStr = '\t';
            var newLine = '\n';
            var char = '';

            for (var i=0; i<strLen; i++) {
                char = str.substring(i,i+1);

                if (char == '}' || char == ']') {
                    retval = retval + newLine;
                    pos = pos - 1;

                    for (var j=0; j<pos; j++) {
                        retval = retval + indentStr;
                    }
                }

                retval = retval + char;

                if (char == '{' || char == '[' || char == ',') {
                    retval = retval + newLine;

                    if (char == '{' || char == '[') {
                        pos = pos + 1;
                    }

                    for (var k=0; k<pos; k++) {
                        retval = retval + indentStr;
                    }
                }
            }

            return retval;
        }

        function getDefaultParams()
        {
            var dParams = {};
            var cmdDefaults = $.cookie("cmdDefaults");
            if(typeof(cmdDefaults)!='undefined')
            {
                $('#defaultEdit').val(cmdDefaults);
                try {
                    var dParams = JSON.parse(cmdDefaults);
                } catch(e) {
                    console.log(cmdDefaults);
                    alert("error loading defaults: " + e.message);
                    dParams = {};
                }
            }
            return dParams;
        }

        function initParams(inputEdit, outputEdit)
        {
            var cmd = Env.module + "." + Env.function;
            var dParams = getDefaultParams();
            var input = {cmd:cmd};
            if(cmd!='reg.login' && cmd!='reg.check' && cmd!='reg.create')
            {
                var key = "session";
                if(typeof(dParams[key]) != 'undefined') {
                    input[key] = dParams[key];
                } else {
                    input.session = 'xxxx';
                }
            }

            $('#moduleName').text(Env.module);
            $('#functionName').text(Env.function);
            var funcInfo = Env.functions[Env.function];
            $('#functionDescription').text(funcInfo.desc);
            var paramInfo = "";
            console.log(funcInfo);
            for (key in funcInfo.params)
            {
                var dtype = funcInfo.params[key].dtype;
                paramInfo += key + "=" + dtype;
                if(typeof(funcInfo.params[key].options) != 'undefined')
                {
                    paramInfo += "(" + funcInfo.params[key].options + ")";
                }
                paramInfo += "<br>";

                if(typeof(dParams[key]) != 'undefined') {
                    input[key] = dParams[key];
                    continue;
                }
                if(dtype == 'object') {
                    input[key] = null;
                } else if (dtype == 'array') {
                    input[key] = null;
                } else if (dtype == 'int') {
                    input[key] = 0;
                } else if (dtype == 'float') {
                    input[key] = 0.0;
                } else if (dtype == 'array') {
                    input[key] = [];
                } else if (dtype == 'string') {
                    input[key] = '';
                }
            }
            if(paramInfo.length==0)
            {
                paramInfo = "(none)";
            }
            $('#functionParams').html(paramInfo);
            inputEdit.set(input);
            outputEdit.set();
        }


        $(init);
        function init()
        {
            var inputContainer = document.getElementById("inputEditor");
// SWD - graphic editor
//    var inputEdit = new jsoneditor.JSONEditor(container);
            var inputEdit = new jsoneditor.JSONFormatter(inputContainer);
            var outputContainer = document.getElementById("outputEditor");
            var outputEdit = new jsoneditor.JSONFormatter(outputContainer);

            initParams(inputEdit, outputEdit);

            $('#saveDefaults').click(function() {
                var cmdDefaults = $('#defaultEdit').val();
                var data = formatJson(cmdDefaults);
                $('#defaultEdit').val(data);
                $.cookie("cmdDefaults", data, {path: '/', expires: 365});
            });

            $('#callFunction').click(function() {
                try {
                    var input = inputEdit.get();
                } catch (e) {
                    alert("error parsing input: " + e.message);
                }
                console.log(input);
                $.ajax
                        ({
                            type: "POST",
                            url: Env.restUrl,
                            dataType: 'json',
                            async: false,
                            data: input,
                            success: function (data, status) {
                                outputEdit.set(data);
                            }
                        })
            });
            $('#resetFunction').click(function() {
                initParams(inputEdit, outputEdit)
            });
        }
    </script>
</head>
<body>
<table border="0" style="float:left;">
    <tr>
        <td class="nameCell">module:</td><td><div id="moduleName">{module_name}</div></td>
    </tr>
    <tr>
        <td class="nameCell">function:</td><td><div id="functionName">{function_name}</div></td>
    </tr>
    <tr>
        <td class="nameCell">description:</td><td><div id="functionDescription">{function_description}</div></td>
    </tr>
    <tr>
        <td class="nameCell" style="vertical-align: text-top;">params:</td><td><div id="functionParams">{function_params}</div></td>
    </tr>
</table>
<textarea id="defaultEdit" style="float:right;height:145;width:300;"></textarea>
<button id="saveDefaults" style="float:right">set</button>
<div style="clear:both"/>
<p>
    <button id="callFunction">call function</button>
    <button id="resetFunction">reset</button>
</p>
<div id="inputEditor"></div>
<div id="outputEditor"></div>
</body>
</html>