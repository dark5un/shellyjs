<html>
<head>
<title>Game Simulator</title>
    <script src="/static/js/jquery-1.7.1.min.js"></script>
    <script src="/static/js/jquery.cookie.js"></script>
    <script src="/static/js/ba-debug.js"></script>

    <link rel="stylesheet" type="text/css" href="/static/jsoneditor-2.0.0/jsoneditor.css">
    <script type="text/javascript" src="/static/jsoneditor-2.0.0/jsoneditor.js"></script>
    <style type="text/css">
        #user1Editor {
            width: 100%;
            height: 200px;
        }
        #user2Editor {
            width: 100%;
            height: 200px;
        }
        body {
            font-family:verdana,arial,sans-serif;
            font-size:10pt;
            margin:30px;
        }
        .nameCell {
            font-weight: bold;
            width: 100px;
        }
    </style>
    <script language="javascript">
        var Env = new Object();
        var Env = {{{params}}};

        function log(msg)
        {
            if (typeof(msg) == 'object') {
//                msg = "<div style='color:red;'>" + JSON.stringify(msg) + "/div>";
                msg = JSON.stringify(msg);
            }
            var $mlog = $("#messageLog");
            $mlog.append(msg+"\n").scrollTop($mlog[0].scrollHeight - $mlog.height());
        }

        function formatJson(val) {
            val = val.replace(/(\n|\t)/gm, '');	// strip all newlines first

            var retval = '';
            var str = val;
            var pos = 0;
            var strLen = str.length;
            var indentStr = '\t';
            var newLine = '\n';
            var char = '';

            for (var i=0; i<strLen; i++) {
                char = str.substring(i,i+1);

                if (char == '}' || char == ']') {
                    retval = retval + newLine;
                    pos = pos - 1;

                    for (var j=0; j<pos; j++) {
                        retval = retval + indentStr;
                    }
                }

                retval = retval + char;

                if (char == '{' || char == '[' || char == ',') {
                    retval = retval + newLine;

                    if (char == '{' || char == '[') {
                        pos = pos + 1;
                    }

                    for (var k=0; k<pos; k++) {
                        retval = retval + indentStr;
                    }
                }
            }

            return retval;
        }


        function setDefaultParam($defaults, name, value)
        {
            var dParams = getDefaultParams($defaults);
            dParams[name] = value;
            var cmdDefaults =formatJson(JSON.stringify(dParams));
            $defaults.val(cmdDefaults);

            saveDefaultParams($defaults);
        }

        function saveDefaultParams($defaults)
        {
           var cmdDefaults = $defaults.val();
           console.log("saving: " + $defaults.attr("id") + " = " + cmdDefaults);
           $.cookie($defaults.attr("id"), cmdDefaults, {path: '/', expires: 365});
        }

        function getDefaultParams($defaults)
        {
            var dParams = {};
            var cmdDefaults = $defaults.val();
            try {
                var dParams = JSON.parse(cmdDefaults);
            } catch(e) {
                console.log(cmdDefaults);
//                    alert("error loading defaults: " + e.message);
            }
            return dParams;
        }

        function initDefaultParams($defaults)
        {
            var dParams = {};
            var cmdDefaults = $.cookie($defaults.attr("id"));
            if(typeof(cmdDefaults)!='undefined')
            {
                $defaults.val(cmdDefaults);
                try {
                    var dParams = JSON.parse(cmdDefaults);
                } catch(e) {
                    console.log(cmdDefaults);
//                    alert("error loading defaults: " + e.message);
                    dParams = {};
                }
            } else {
                $defaults.val("{}");
            }
            return dParams;
        }

        function populateCmd(name, target, $defaults)
        {
            var dParams = getDefaultParams($defaults)

            cmd = "game." + name;
            var input = {cmd:cmd};
            var key = "session";
            if(typeof(dParams[key]) != 'undefined') {
                input[key] = dParams[key];
            } else {
                input.session = 'xxxx';
            }

            var paramInfo = "";
            var funcInfo = Env.functions[name];
            for (key in funcInfo.params)
            {
                var dtype = funcInfo.params[key].dtype;

                if(typeof(dParams[key]) != 'undefined') {
                    input[key] = dParams[key];
                    continue;
                }
                if(dtype == 'object') {
                    input[key] = null;
                } else if (dtype == 'array') {
                    input[key] = null;
                } else if (dtype == 'int') {
                    input[key] = 0;
                } else if (dtype == 'float') {
                    input[key] = 0.0;
                } else if (dtype == 'array') {
                    input[key] = [];
                } else if (dtype == 'string') {
                    input[key] = '';
                }
            }
            target.set(input);
        }

        function setState(resp)
        {
            var data = resp;
            if($("#stripMsg").attr("checked") == "checked" && resp.error == 0) {
                data = resp.data;
            }
            var niceJson = formatJson(JSON.stringify(data));
            $("#gameState").val(niceJson);
        }

        function callServer(input)
        {
            console.log(input);
            $.ajax
                    ({
                        type: "POST",
                        url: 'http://localhost:5101/api',
                        dataType: 'json',
                        async: false,
                        data: input,
                        success: function (res, status) {
                            log(res);
                            setState(res);
                            if(typeof(res.data.gameId) != 'undefined')
                            {
                                setDefaultParam($("#user1Defaults"), "gameId", res.data.gameId);
                                setDefaultParam($("#user2Defaults"), "gameId", res.data.gameId);
                            }
                        },
                        error: function (xhr, status, error) {
                            log(xhr.responseText);
                        }
                    })
        }

        $(init);
        function init()
        {
            var inputContainer = document.getElementById("user1Editor");
// SWD - graphic editor
//    var user1Edit = new jsoneditor.JSONEditor(container);
            var user1Edit = new jsoneditor.JSONFormatter(inputContainer);
            var user2Container = document.getElementById("user2Editor");
            var user2Edit = new jsoneditor.JSONFormatter(user2Container);

            var $user1Defaults = $("#user1Defaults");
            var $user2Defaults = $("#user2Defaults");

            initDefaultParams($user1Defaults);
            initDefaultParams($user2Defaults);

            $('#user1SetDefaults').click(function() {
                saveDefaultParams($user1Defaults);
            });

            $('#user2SetDefaults').click(function() {
                saveDefaultParams($user2Defaults);
            });


            $('#user1Create').click(function() {
                populateCmd("create", user1Edit, $user1Defaults);
            });
            $('#user1Kick').click(function() {
                populateCmd("kick", user1Edit, $user1Defaults);
            });
            $('#user1Turn').click(function() {
                populateCmd("turn", user1Edit, $user1Defaults);
            });
            $('#gameGet').click(function() {
                populateCmd("get", user1Edit, $user1Defaults);
            });

            $('#user2Join').click(function() {
                populateCmd("join", user2Edit, $user2Defaults);
            });
            $('#user2Turn').click(function() {
                populateCmd("turn", user2Edit, $user2Defaults);
            });
            $('#user2Leave').click(function() {
                populateCmd("leave", user2Edit, $user2Defaults);
            });


            $('#user1CallFunction').click(function() {
                var input = user1Edit.get();
                callServer(input);
            });
            $('#user2CallFunction').click(function() {
                var input = user2Edit.get();
                callServer(input);
            });

            $('#resetFunction').click(function() {
                initParams(user1Edit, user2Edit)
            });
        }
    </script>
</head>
<body>
<p>
</p>
<table style="width:100%;">
    <tr>
        <td style="width:70%;">game state <input id="stripMsg" type="checkbox" checked="checked">strip envelope no error</input></td>
        <td>default params</td>
    </tr>
    <tr>
        <td><textarea id="gameState" style="height:300;width:100%;"></textarea></td>
        <td valign="top">
            User 1<button id="user1SetDefaults" style="float:right">set</button>
            <textarea id="user1Defaults" style="height:100;width:100%;"></textarea>
            User 2<button id="user2SetDefaults" style="float:right">set</button>
            <textarea id="user2Defaults" style="height:100;width:100%;"></textarea>
        </td>
    </tr>
</table>
<table style="width:100%;">
    <tr>
        <td style="width:50%;">user 1</td>
        <td>user 2</td>
    </tr>
    <tr>
        <td>
            <button id="user1Create">create</button>
            <button id="gameGet">info</button>
            <button id="">notify</button>
            <button id="user1Turn">turn</button>
            <button id="user1Kick">kick</button>
            <button id="user1CallFunction" style="float:right;">make call</button>
        </td>
        <td>
            <button id="user2Join">join</button>
            <button id="user2Leave">leave</button>
            <button id="user2Turn">turn</button>
            <button id="user2CallFunction" style="float:right;">make call</button>
        </td>
    </tr>
    <tr>
        <td><div id="user1Editor"></div></td>
        <td><div id="user2Editor"></div></td>
    </tr>
</table>

<table style="width:100%;">
    <tr>
        <td style="width:70%;">message log</td>
    </tr>
    <tr>
        <td><textarea id="messageLog" readonly style="height:100;width:100%;"></textarea></td>
    </tr>
</table>

</body>
</html>