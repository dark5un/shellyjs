<html xmlns="http://www.w3.org/1999/html">
<head>
<title>Tic Tac Toe</title>
    <script src="/static/js/jquery-1.7.1.min.js"></script>
    <script src="/static/js/jquery.cookie.js"></script>
    <script src="/static/js/ba-debug.js"></script>
    <script src="/static/js/reconnecting-websocket.js"></script>

    <link rel="stylesheet" type="text/css" href="/static/jsoneditor-2.0.0/jsoneditor.css">
    <script type="text/javascript" src="/static/jsoneditor-2.0.0/jsoneditor.js"></script>
    <style type="text/css">
        #user1Editor {
            width: 100%;
            height: 200px;
        }
        #user2Editor {
            width: 100%;
            height: 200px;
        }
        body {
            font-family:verdana,arial,sans-serif;
            font-size:10pt;
            margin:30px;
        }
        .nameCell {
            font-weight: bold;
            width: 100px;
        }
        .tictac {
            height: 50;
            width: 50;
        }
    </style>
    <script language="javascript">
        var Env = new Object();
        Env.baseParams = {session: "1:33:xxxx:0",
                          gameId: "161"
                         }

        function clone(obj) {
            return $.extend({}, obj);
        }

        function log(api, type, msg)
        {
            color = "black";
            bodyColor = "black";
            if(type=="error") {
                color = "red"
                bodyColor = "red";
            }
            if(api=="rest") {
                color = "blue";
            }
            if(api=="socket") {
                color = "green";
            }
            if (typeof(msg) == 'object') {
                msg = JSON.stringify(msg);
            }
            var $mlog = $("#messageLog");
            var disp = "<div style='font-size:10px;white-space:nowrap;'>";
            disp += "<span style='color:" + color + ";'>" + api + ": </span>";
            disp += "<span style='color:" + color + ";'>" + type + ": </span>";
            disp += "<span style='color:" + bodyColor + ";'>" + msg + "</span>";
            disp += "</div>";
            $mlog.append(disp).scrollTop($mlog[0].scrollHeight - $mlog.height());
        }

        function setState(game)
        {
            var gameBoard = game.state.gameBoard;
            for (x in gameBoard) {
                for (y in gameBoard[x]) {
                    $("#"+x+y).val(gameBoard[x][y]);
                }
            }
            if(typeof(game.gameId) != 'undefined') {
                $("#gameId").text(game.gameId);
                Env.baseParams.gameId = game.gameId;
            }
        }

        function callServer(input)
        {
            log("rest", "send", input);
            $.ajax
                    ({
                        type: "POST",
                        url: 'http://localhost:5101/api',
                        dataType: 'json',
                        async: false,
                        data: input,
                        success: function (res, status) {
                            log("rest", "recv", res);
                            if(res.error == 0)
                            {
                                if(typeof(res.data.event) != 'undefined') {
                                    setState(res.data.game);
                                } else {
                                    setState(res.data);
                                }
                            } else {
                                log("rest", "error", res.error + " : " + JSON.stringify(res.data));
                            }
                        },
                        error: function (xhr, status, error) {
                            log("rest", "error", xhr.responseText);
                        }
                    })
        }

        function turn(x, y) {
            var data = clone(Env.baseParams);
            data.cmd = "game.turn";
            data.move = {x:x, y:y};
            callServer(data);
        }

        var url = "ws://localhost:5102";
        var ws = new ReconnectingWebSocket(url);
        ws.onopen = function() {
            log("socket", "onopen", url);
            gameInit();
            //listReadyGames();
        };
        ws.onmessage = function (evt) {
            var received_msg = evt.data;
            log("socket", "onmessage", evt.data);
            var msg = JSON.parse(evt.data);
            if(msg.error != 0) {
                log("socket", "error", msg.error + " : " + JSON.stringify(msg.data));
            }
            if(msg.error == 0 && (msg.cmd == 'game.turn' || msg.cmd == 'gqueue.nextAvailable')) {
                if(typeof(msg.data.event) != 'undefined') {
                    setState(msg.data.game);
                } else {
                    setState(msg.data);
                }
            }
//            alert("Message is received...");
        };
        ws.onclose = function() {
        };

        function sendWs(data)
        {
            var msg = JSON.stringify(data);
            log("socket", "send", msg);
            ws.send(msg);
        }

        function listReadyGames()
        {
            var data = clone(Env.baseParams);
            data.cmd = "match.list";
            sendWs(data);
        }

        function gameInit()
        {
            var data = clone(Env.baseParams);
            data.cmd = "game.join";
            sendWs(data);
        }

        function getURLParameter(name) {
            return decodeURI(
                    (RegExp(name + '=' + '(.+?)(&|$)').exec(location.search)||[,null])[1]
            );
        }
        var psess = getURLParameter("session");
        if(psess != 'null')
        {
            Env.baseParams.session = psess;
        }
        var pgameId = getURLParameter("gameId");
        if(pgameId != 'null')
        {
            Env.baseParams.gameId = pgameId;
        }

        $(init);
        function init()
        {
            $("#user1Defaults").val(Env.baseParams.session);

            $("#uid").text(Env.baseParams.session.split(':')[1]);
            $("#gameId").text(Env.baseParams.gameId);
            $("#session").text(Env.baseParams.session);

            var data = clone(Env.baseParams);
            data.cmd = "game.get";
            callServer(data);

            $(".tictac").click(function() {
                var id = $(this).attr("id");
                var x = id.slice(0,2);
                var y = id.slice(2,4);
                turn(x, y);
            });

            $("#gameCreate").click(function() {
                var data = clone(Env.baseParams);
                delete data.gameId;
                data.cmd = "game.create";
                data.name = "tictactoe";
                callServer(data);
            });

            $("#gameReset").click(function() {
                var data = clone(Env.baseParams);
                data.cmd = "game.reset";
                callServer(data);
            });

            $("#gameInvite").click(function() {
                var data = clone(Env.baseParams);
                data.cmd = "gqueue.add";
                data.data = {display: "fun game"};
                callServer(data);
            });

            $("#gameFind").click(function() {
                var data = clone(Env.baseParams);
                data.cmd = "gqueue.nextAvailable";
                delete data.gameId;
                sendWs(data);
//                callServer(data);
            });

            $("#gameUpdate").click(function() {
                var data = clone(Env.baseParams);
                data.cmd = "game.get";
                callServer(data);
            });

        }
    </script>
</head>
<body>
<p>
</p>
<table border="1" style="width:100%;">
    <tr>
        <td style="width:70%;">list games</td>
        <td>default params</td>
    </tr>
    <tr>
        <td valign="top" style="">
            <div id="gameList">
                <div id="gameTemplate" style="">
                    <span id="gameName">game1</span><button>join</button>
                </div>
             </div>
        </td>
        <td valign="top">
            User<button id="tttSetDefaults" style="float:right">set</button>
            <textarea id="tttDefaults" style="height:100;width:100%;"></textarea>
        </td>
    </tr>
</table>

<FORM NAME="tic">
    <input type="button" id="x1y1" class="tictac" value=" "/>
    <input type="button" id="x1y2" class="tictac" value=" "/>
    <input type="button" id="x1y3" class="tictac" value=" "/><br/>
    <input type="button" id="x2y1" class="tictac" value=" "/>
    <input type="button" id="x2y2" class="tictac" value=" "/>
    <input type="button" id="x2y3" class="tictac" value=" "/><br/>
    <input type="button" id="x3y1" class="tictac" value=" "/>
    <input type="button" id="x3y2" class="tictac" value=" "/>
    <input type="button" id="x3y3" class="tictac" value=" "/>
</form>

<table border="1" style="width:100%;">
    <tr>
        <td style="width:50%;">user=<span id="uid"></span> game=</span><span id="gameId">0</span> session=<span id="session"></span></td>
    </tr>
    <tr>
        <td>
            <button id="gameCreate">create</button>
            <button id="gameInvite">invite</button>
            <button id="gameFind">find game</button>
            <button id="gameUpdate">update</button>
            <button id="">notify</button>
            <button id="user1Kick">kick</button>
            <button id="gameReset" style="float:right;">reset</button>
        </td>
    </tr>
</table>

<table style="width:100%;">
    <tr>
        <td style="width:70%;">message log</td>
    </tr>
    <tr>
        <td><div id="messageLog" readonly style="height:200;width:100%;overflow:scroll;"></div></td>
    </tr>
</table>

</body>
</html>