<html xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html">
<head>
<title>Lobby</title>
    <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet"
          type="text/css"/>
    <script src="/static/js/jquery-1.7.1.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>

    <script src="/static/js/jquery.cookie.js"></script>
    <script src="/static/js/ba-debug.js"></script>
    <script src="/static/js/reconnecting-websocket.js"></script>
    <script src='/static/js/fastclick.js'></script>
    <script src='common.js'></script>

    <link rel="stylesheet" type="text/css" href="/static/jsoneditor-2.0.0/jsoneditor.css">
    <script type="text/javascript" src="/static/jsoneditor-2.0.0/jsoneditor.js"></script>

    <link rel="stylesheet" type="text/css" href="/static/css/shadmin.css">
    <link rel="stylesheet" type="text/css" href="/static/css/shgame.css">
<style type="text/css">
    button {
        font-size: 12pt;
    }
</style>
<script language="javascript">
var Env = {{{EnvJson}}};
Env.baseParams = {};

function setMatchInfo(matchList) {
    $(".activeMatch").remove();
    for (gameName in matchList) {
        var $newGame = $("#matchTemplate").clone();
        $newGame.find("#matchName").text(gameName);
        $newGame.find("#matchTime").text(prettyDate(matchList[gameName].lastCreated));
        $newGame.attr("gameName", gameName);
        $newGame.addClass("activeMatch");
        $newGame.css("display", "block");

        $("#matchList").append($newGame);
    }
}

function removeUser(uid) {
    $(".userId" + uid).remove();
}

function addUser(user) {
    if ($(".userId" + user.uid).size() > 0) {
        return;
    }
    var $newGame = $("#userTemplate").clone();
    $newGame.find("#userName").text(user.name);
    $newGame.find("#userName").addClass("playerName" + user.uid);
    $newGame.addClass("userId" + user.uid);
    $newGame.addClass("activeUser");
    $newGame.attr("uid", user.uid);
    $newGame.css("display", "block");

    if (user.uid === Env.uid) {
        $("#currentUserName").text(user.name);
    }

    $newGame.find("#userOffer").click(function () {
        alert("not implemented");
//                var gameId = $(this).parent().attr('gameId');
    });

    $("#userList").append($newGame);
}

function gameInit(gameId) {
    window.location.href = "/games/tictactoe.html?gameId=" + gameId;
}

function processEvent(res, from) {
    if (typeof(res.event) == 'undefined') {
        log(from, "error", "old message: " + JSON.stringify(res));
        return;
    }
    if (res.event == 'event.error') {
        showError(res.message);
        log(from, "error", JSON.stringify(res));
        return;
    }
    if (res.event == 'event.heartbeat') {
        return;
    }
    if (res.event == 'event.game.playing') {
        setMyGames(res.data);
        return;
    }
    if (res.event == 'event.game.turn.next') {
        setWhoTurn(res.data.gameId, res.data.whoTurn, res.data);
        return;
    }
    if (res.event == 'event.live.user') {
        if (res.data.status === "online") {
            addUser(res.data);
        } else {
            removeUser(res.data.uid);
        }
        return;
    }
    if (res.event == 'event.match.stats') {
        setMatchInfo(res.data);
        return;
    }
    if (res.event == 'event.match.made') {
        var addParam = "";
        var psess = getURLParameter("session");  // done for testing two users in same browser
        if (psess != 'null') {
            addParam = "&session=" + psess;
        }
        window.location.href = "/games/tictactoe.html?gameId=" + res.data.gameId + addParam;
        return;
    }
    if (res.event == 'event.match.add') {
        return;
    }
    log(from, "unknown-event", JSON.stringify(res));
}

function shellyInit() {
    sendCmd("live.user", {status: "on"});
    sendCmd("game.playing");
    sendCmd("match.stats");
}

$(init);
function init() {
    $("#shSystem").text("Example");
    $("#shSubTitle").text("Lobby");
    $("#uid").text(Env.user.uid);

    Env.shToken = $.cookie("shToken");
    if (typeof (Env.shToken) === "undefined") {
        log("main", "info", "shToken undefined - using/setting nextUuid: " + Env.nextUuid);
        Env.shToken = Env.nextUuid;
        $.cookie("shToken", Env.nextUuid, { expires: 3650, path: '/' });
    }
    log("main", "info", "shToken using: " + Env.shToken);
    $("#token").text(Env.shToken);
    $("#session").text(Env.session);

    $("#version").text(Env.version);

    window.addEventListener('load', function () {
        new FastClick(document.body);
    }, false);

    $("#gameTicTacToe").click(function () {
        sendCmd("match.add", {name: "tictactoe"});
        $("#dialog").dialog();
    });
    $("#setUserInfo").click(function () {
        var name = prompt("Please enter a nick name.", "")
        if (name != null && name != "") {
            sendCmd("user.set", {user: {name: name}});
            $("#currentUserName").text(name);
        }
    });
    $("#liveHide").click(function () {
        sendCmd("live.user", {status: "off"});
    });
    $("#liveShow").click(function () {
        sendCmd("live.user", {status: "on"});
    });
    $("#logoutBtn").click(function () {
        window.location.href = "/login/logout.html";
    });

    ws.connect(Env.socketUrl);
}
</script>
</head>
<body>
{{> header}}
{{> gameNav}}
<table border="1" style="width:100%;">
    <tr>
        <td>Hello <span id="currentUserName"></span> (<span id="uid"></span>)
            <button id="setUserInfo" style="float:right">set</button>
        </td>
        <td>Users in Lobby</td>
        <td>Games Your Playing<span style="float:right;" id="version"></span></td>
    </tr>
    <tr>
        <td valign="top">
            <div id="matchList" style="height:150;overflow:scroll;">
                <div id="matchTemplate" style="display:none;">
                    <span id="matchName">game0</span> =
                    <span id="matchTime">time</span>
                </div>
            </div>
        </td>
        <td valign="top">
            <div id="userList" style="height:150;overflow:scroll;">
                <div id="userTemplate" style="display:none;">
                    <span id="userName">open-game-0</span>
                    <button id="userOffer" style="float:right">offer</button>
                    <div style="clear:both"></div>
                </div>
            </div>
        </td>
        <td valign="top">
            <div id="gameList" style="height:150;overflow:scroll;">
                <div id="gameTemplate" style="display:none;">
                    <span id="gameName">game-0</span>
                    (<span id="gameTurn">?</span>)
                    <button style="float:right;" id="myGameRemove">remove</button>
                    <button style="float:right;" id="myGameJoin">play</button>
                    <div style="clear:both"></div>
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="errorMessage" style="display:none;width:100%;background:pink;color:red;">error</div>

<table border="1" style="width:100%;">
    <tr>
        <td style="width:50%;">Games</td>
    </tr>
    <tr>
        <td>
            <button id="gameTicTacToe">Play TicTacToe</button>
            <button id="liveHide" style="float:right">offline</button>
            <button id="liveShow" style="float:right">online</button>
        </td>
    </tr>
</table>
<div style="margin: 10px 0px;"><b>Message Log</b></div>
<div id="messageLog" readonly style="height:200;width:100%;overflow:scroll;"></div>

<style>
    .waitOptionDiv {
        margin: 10px;
    }
</style>
<div id="dialog" style="display:none" title="Ready to Play">
    <div class="waitOptionDiv">waiting for user to join you...</div>
    <div class="waitOptionDiv">Or give us your email and we'll notify you.</div>
    <div class="waitOptionDiv">Or come back later.</div>
</div>
<div style="position: absolute; bottom: 0px; left: 0px; font-size: 14px">
    <div>session=<span id="session"></span></div>
    <div">token=<span id="token"></span></div>
</div>
</body>
</html>