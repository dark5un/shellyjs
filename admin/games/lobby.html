<html xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html">
<head>
<title>Lobby</title>
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css" />
    <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
    <script src="http://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>

    <script src="/static/js/jquery.cookie.js"></script>
    <script src="/static/js/ba-debug.js"></script>
    <script src="/static/js/reconnecting-websocket.js"></script>
    <script src='/static/js/fastclick.js'></script>
    <script src='common.js'></script>

    <link rel="stylesheet" type="text/css" href="/static/css/shadmin.css">
    <link rel="stylesheet" type="text/css" href="/static/css/shgame.css">

    <script language="javascript">
var Env = {{{EnvJson}}};
Env.baseParams = {};

function setMatchInfo(matchList) {
    $(".activeMatch").remove();
    for (gameName in matchList) {
        var $newGame = $("#matchTemplate").clone();
        $newGame.find("#matchName").text(gameName);
        $newGame.find("#matchTime").text(prettyDate(matchList[gameName].lastCreated));
        $newGame.attr("gameName", gameName);
        $newGame.addClass("activeMatch");
        $newGame.css("display", "block");

        $("#matchList").append($newGame);
    }
}

function removeUser(uid) {
    $(".userId" + uid).remove();
}

function addUser(user) {
    if ($(".userId" + user.uid).size() > 0) {
        return;
    }
    var $newGame = $("#userTemplate").clone();
    $newGame.find("#userName").text(user.name);
    $newGame.find("#userName").addClass("playerName" + user.uid);
    $newGame.addClass("userId" + user.uid);
    $newGame.addClass("activeUser");
    $newGame.attr("uid", user.uid);
    $newGame.css("display", "block");

    $newGame.find("#userOffer").click(function () {
        alert("not implemented");
//                var gameId = $(this).parent().attr('gameId');
    });

    $("#userList").append($newGame);
}

function gameInit(gameId) {
    window.location.href = "/games/tictactoe.html?gameId=" + gameId;
}

function processEvent(res, from) {
    if (typeof(res.event) == 'undefined') {
        log(from, "error", "old message: " + JSON.stringify(res));
        return;
    }
    if (res.event == 'event.error') {
        showError(res.message);
        log(from, "error", JSON.stringify(res));
        return;
    }
    if (res.event == 'event.heartbeat') {
        return;
    }
    if (res.event == 'event.game.playing') {
        setMyGames(res.data);
        return;
    }
    if (res.event == 'event.game.turn.next') {
        setWhoTurn(res.data.gameId, res.data.whoTurn, res.data);
        return;
    }
    if (res.event == 'event.live.user') {
        if (res.data.status === "online") {
            addUser(res.data);
        } else {
            removeUser(res.data.uid);
        }
        return;
    }
    if (res.event == 'event.match.stats') {
        setMatchInfo(res.data);
        return;
    }
    if (res.event == 'event.match.made') {
        window.location.href = "/games/tictactoe.html?gameId=" + res.data.gameId;
        return;
    }
    if (res.event == 'event.match.add') {
        return;
    }
    log(from, "unknown-event", JSON.stringify(res));
}

function shellyInit() {
    sendCmd("live.user", {status: "on"});
    sendCmd("game.playing");
    sendCmd("match.stats");
}

$(init);
function init() {
    $("#shSystem").text("Example");
    $("#shSubTitle").text("Lobby");

    window.addEventListener('load', function () {
        new FastClick(document.body);
    }, false);

    $("#gameTicTacToe").click(function () {
        sendCmd("match.add", {name: "tictactoe"});
        $("#dialog").dialog();
    });
    $("#setUserInfo").click(function () {
        var name = prompt("Please enter a nick name.", "")
        if (name != null && name != "") {
            sendCmd("user.set", {user: {name: name}});
            $("#currentUserName").text(name);
        }
    });
    $("#liveHide").click(function () {
        sendCmd("live.user", {status: "off"});
    });
    $("#liveShow").click(function () {
        sendCmd("live.user", {status: "on"});
    });
    $("#logoutBtn").click(function () {
        window.location.href = "/login/logout.html";
    });

    ws.connect(Env.socketUrl);
}
</script>
    <style>
        .playAnyoneDiv {
            width: 300px;
        }
        .lobbyUsersDiv {
            width: 300px;
        }
        #userList {
            height: 150px;
        }
        .gameListDiv {
            float: left;
            width: 300px;
        }
        #gameList {
            height: 150px;
        }
        #messageLog {
            height: 200px;
        }
    </style>
</head>
<body>
{{> header}}
{{> gameNav}}

<div id="errorMessage" style="display:none;width:100%;background:pink;color:red;">error</div>

<div style="float:left; margin-bottom: 5px;">
    <div class="playAnyoneDiv gameBoxDiv">
        <div class="gameBoxHeaderDiv">Play Anyone Now</div>
        <div id="playNowList" class="gameBoxInnerDiv">
            <button id="gameTicTacToe">TicTacToe</button>
            <button id="liveHide" style="float:right">offline</button>
            <button id="liveShow" style="float:right">online</button>
            <button id="setUserInfo" style="float:right">set name</button>
        </div>
    </div>
    <div class="lobbyUsersDiv gameBoxDiv">
        <div class="gameBoxHeaderDiv">Users in Lobby</div>
        <div id="userList" class="gameBoxInnerDiv">
            <div id="userTemplate" style="display:none;">
                <span id="userName">open-game-0</span>
                <button id="userOffer" style="float:right">offer</button>
                <div style="clear:both"></div>
            </div>
        </div>
    </div>
</div>

<div class="gameListDiv gameBoxDiv">
    <div class="gameBoxHeaderDiv">Recent Games</div>
    <div id="gameList" class="gameBoxInnerDiv">
        <div id="gameTemplate" style="display:none;">
            <span id="gameName">game-0</span>
            (<span id="gameTurn">?</span>)
            <button style="float:right;" id="myGameRemove">remove</button>
            <button style="float:right;" id="myGameJoin">play</button>
            <div style="clear:both"></div>
        </div>
    </div>
</div>

<div style="clear:both"></div>

<div class="matchListDiv" style="display:none;">
    <div class="gameBoxHeaderDiv">Game Activity</div>
    <div id="matchList" class="gameBoxInnerDiv">
        <div id="matchTemplate" style="display:none;">
            <span id="matchName">game0</span> =
            <span id="matchTime">time</span>
        </div>
    </div>
</div>

<div class="messageLogDiv gameBoxDiv">
    <div class="gameBoxHeaderDiv"<b>Message Log</b></div>
    <div id="messageLog" class="gameBoxInnerDiv" readonly></div>
</div>

<style>
    .waitOptionDiv {
        margin: 10px;
    }
</style>
<div id="dialog" style="display:none" title="Ready to Play">
    <div class="waitOptionDiv">waiting for user to join you...</div>
    <div class="waitOptionDiv">Or give us your email and we'll notify you.</div>
    <div class="waitOptionDiv">Or come back later.</div>
</div>

{{> footer}}
</body>
</html>