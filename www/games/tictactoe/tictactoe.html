<html xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html">
<head>
<title>Tic Tac Toe</title>
<link rel="stylesheet" href="/common/jquery-ui-1.10.2/css/smoothness/jquery-ui.css" />
<script src="/common/jquery-1.9.1.js"></script>
<script src="/common/jquery-ui-1.10.2/js/jquery-ui.js"></script>
<script src="/common/jquery.cookie.js"></script>
<script src="/static/js/ba-debug.js"></script>
<script src="/static/js/reconnecting-websocket.js"></script>
<script src="/static/js/fastclick.js"></script>
<script src="/static/js/common.js"></script>

<link rel="stylesheet" type="text/css" href="/static/css/shadmin.css">
<link rel="stylesheet" type="text/css" href="/static/css/shgame.css">

<style type="text/css">
    button {
        font-size: 8pt;
    }
    .gameBoardDiv {
        width: 291px;
        float:left;
    }
    .gamePlayersDiv,
    .gameInfoDiv {
        width: 200px;
    }

    .otherTurnsDiv {
        width: 291px;
    }
    #gameMyTurnList {
        overflow: auto;
        height: 75px;
    }


    .tictac {
        display: block;
        float: left;
        border-style: solid;
        border-color: #bbb #888 #666 #aaa;
        border-width: 3px 4px 4px 3px;
        width: 90px;
        height: 50px;
        background: #ccc;
        color: #333;
        line-height: 50px;
        text-align: center;
        text-decoration: none;
        font-weight: 900;
        font-size: xx-large;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }
</style>
<script language="javascript">
var Env = {{{EnvJson}}};

Env.players = {};
Env.gameId = "0";

var pgameId = getURLParameter("gameId");
if (pgameId != "null") {
    Env.gameId = pgameId.toString();
}

function setPlayers(playerList, whoTurn) {
    $(".activePlayer").remove();
    for (playerId in playerList) {
        var $newGame = $("#playerTemplate").clone();
        if (playerId === Env.user.oid) {
            $newGame.find("#playerName").text("me");
            $newGame.find("#playerKick").remove();
            $newGame.find("#playerStatus").remove();
        } else {
            $newGame.find("#playerName").addClass("playerName" + playerId);
            $newGame.find("#playerName").text(playerList[playerId].name);
        }
        $newGame.addClass("playerId" + playerId);
        $newGame.addClass("activePlayer");
        $newGame.css("display", "block");

        if (typeof (Env.players[playerId]) != "undefined") {
            $newGame.find("#playerStatus").text(Env.players[playerId].status);
        }

        $newGame.find("#playerKick").click(function () {
            var playerId = $(this).parent().attr("playerId");
        });

        $("#playerList").append($newGame);
    }
    $(".playerId" + whoTurn).find("#playerTurn").text(" - turn");
}

function setState(game) {
    $.cookie("shLastGame" + Env.user.oid, game.oid, { expires: 3650, path: "/" });
    hideError();

    var gameBoard = game.state.gameBoard;
    for (var i = 0; i < 3; i++) {
        for (var j = 0; j < 3; j++) {
            $("#x" + i + "y" + j).text(gameBoard[i][j]);
            $("#x" + i + "y" + j).css("background", "#ccc");
        }
    }

    $("#gameStatus").text(game.status);
    if (game.whoTurn == Env.user.oid) {
        $("#whoTurn").text("yours");
        turnDipl = "yours";
    } else if (game.whoTurn == 0) {
        $("#whoTurn").text("no ones");
    } else {
        $("#whoTurn").text(game.players[game.whoTurn].name);
    }

    if (game.status == "over") {
        showError("game over");
        $("#gameWinner").text(game.players[game.state.winner].name);
    } else {
        $("#gameWinner").text("");
    }

    var winnerSet = game.state.winnerSet;
    if (winnerSet != null) {
        for (var i = 0; i < winnerSet.length; i++) {
            $("#" + winnerSet[i]).css("background", "green");
        }
    }

    if (game.state.xes == Env.user.oid) {
        $("#gamePlaying").text("Xs");
    } else {
        $("#gamePlaying").text("Os")
    }

    $("#gameId").text(game.oid.substr(0, 6) + "..");
    Env.gameId = game.oid;

    setPlayers(game.players, game.whoTurn);
}

function clearState() {
    $.cookie("shLastGame" + Env.user.oid, "0", { expires: 3650, path: "/" });

    hideError();
    for (var i = 0; i < 3; i++) {
        for (var j = 0; j < 3; j++) {
            $("#x" + i + "y" + j).text("");
            $("#x" + i + "y" + j).css("background", "#ccc");
        }
    }

    $("#gameId").text("");
    $("#gameStatus").text("");
    $("#whoTurn").text("");
    $("#gameWinner").text("");
    $("#gamePlaying").text("");

    $(".activePlayer").remove();
}

function shellyInit() {
    if (Env.gameId === "0") {
        var lastGame = $.cookie("shLastGame" + Env.user.oid);
        if (typeof (lastGame) === "string") {
            Env.gameId = lastGame;
        }
    }
    if (Env.gameId !== "0") {
        sendRaw({session: Env.session,
            batch: [{cmd: "game.join", gameId: Env.gameId},
                {cmd: "game.playing"},
                {cmd: "channel2.add", channel: "game:" + Env.gameId}
            ]});
    }
}

function processEvent(res, from) {
    if (typeof(res.event) == "undefined") {
        log(from, "error", "old message: " + JSON.stringify(res));
        return;
    }
    if (res.event == "heartbeat") {
        return;
    }
    if (res.event == "error") {
        showError(res.message);
        log(from, "error", JSON.stringify(res));
        return;
    }
    if (typeof(res.cb) !== "undefined") {
        console.log("handler:", res.cb, res.data);
        window[res.cb](res.data);
        return;
    }
    if (res.event == "game.join") {
        // turn off live events for old game
        var newGameId = res.data.oid;
        var oldGameId = Env.gameId;
        if (typeof (oldGameId) !== "undefined" && oldGameId != newGameId) {
            sendCmd("channel.remove", {channel: "game:" + oldGameId})
            Env.players = {};  // reset the player list
        }
        setState(res.data);
        return;
    }
    if (res.event == "channel.user") {
        Env.players[res.data.uid] = res.data;
        var $playerStatus = $(".playerId" + res.data.uid).find("#playerStatus");
        if ($playerStatus.size) {
            $playerStatus.text(res.data.status);
        }
        return;
    }
    if (res.event === "game.turn.next") {
        if (res.data.gameId != Env.gameId && res.data.whoTurn === Env.user.oid) {
            updateMyTurns(res.data.gameId, res.data.gameName, res.data.whoTurn);
        }
    }
    if (res.event == "game.info"
            || res.event == "game.over"
            || res.event == "game.reset") {
        setState(res.data);
        return;
    }
    if (res.event == "game.playing") {
        setMyTurns(res.data);
        return;
    }
    log(from, "unknown-event", JSON.stringify(res));
}

$(init);
function init() {
    $("#shSystem").text("Example");
    $("#shSubTitle").text("TicTacToe");

    window.addEventListener("load", function () {
        new FastClick(document.body);
    }, false);

    $(".tictac").click(function () {
        var id = $(this).attr("id");
        var x = id.slice(1, 2);
        var y = id.slice(3, 4);
        sendCmd("game.turn", {gameId: Env.gameId, move: {x: x, y: y}})
    });

    $("#gameReset").click(function () {
        sendCmd("game.reset", {gameId: Env.gameId});
    });

    commInit();
    ws.connect(Env.socketUrl);
}
</script>
</head>
<body>
{{> header}}
{{> gameNav}}
{{> errorBox}}

<div class="gameBoardDiv gameBoxDiv">
    <div class="gameBoxHeaderDiv" style="">Game Board</div>
    <div>
        <div id="x0y0" class="tictac"></div>
        <div id="x1y0" class="tictac"></div>
        <div id="x2y0" class="tictac"></div>
        <div id="x0y1" class="tictac"></div>
        <div id="x1y1" class="tictac"></div>
        <div id="x2y1" class="tictac"></div>
        <div id="x0y2" class="tictac"></div>
        <div id="x1y2" class="tictac"></div>
        <div id="x2y2" class="tictac"></div>
    </div>
</div>


<div style="float:left;">
    <div class="gameInfoDiv gameBoxDiv">
        <div class="gameBoxHeaderDiv" style="">Game Info</div>
        <div class="gameBoxInnerDiv">
            <div>game id: <span id="gameId"></span></div>
            <div>status: <span id="gameStatus"></span></div>
            <div>whose turn: <span id="whoTurn"></span></div>
            <div>winner: <span id="gameWinner"></span></div>
            <div>playing: <span id="gamePlaying"></span></div>
            <button id="gameReset" style="float:right">reset</button>
        </div>
    </div>
    <div class="gamePlayersDiv gameBoxDiv">
        <div class="gameBoxHeaderDiv" style="">Game Players</div>
        <div id="playerList" class="gameBoxInnerDiv">
            <div id="playerTemplate" style="display:none;">
                <span id="playerName">player-0</span> <span id="playerStatus">offline</span> </span> <span id="playerTurn"></span>
            </div>
        </div>
    </div>
</div>
<div style="clear: both;"></div>

<div class="otherTurnsDiv gameBoxDiv">
    <div class="gameBoxHeaderDiv">Other Turns</div>
    <div id="gameMyTurnList" class="gameBoxInnerDiv" style="overflow: auto" readonly>
        <div id="gameTemplate" style="display:none;">
            <span id="gameName">game-0</span>
            <span id="gameTurn"></span>
            <button style="float:right;" id="myGameRemove">remove</button>
            <button style="float:right;" id="myGameJoin">play</button>
            <div style="clear:both"></div>
        </div>
    </div>
</div>

<div style="clear: both;"></div>

<div class="commLogDiv gameBoxDiv">
  <div class="gameBoxHeaderDiv">Comm Log<button id="showHideLog" style="float:right;">+</button></div>
  <div id="commLog" class="gameBoxInnerDiv" readonly></div>
</div>

<!-- modal dialog for server disconnected -->
<style>
    .waitOptionDiv {
        margin: 10px;
    }
    .ui-dialog-titlebar {
        display: none;
    }
</style>
<div id="serverConnectDlg" style="height: 150px; display:none">
    <div class="waitOptionDiv">Lost contact with server.</div>
    <div class="waitOptionDiv">Reconnecting...</div>
</div>

{{> footer}}
</body>
</html>