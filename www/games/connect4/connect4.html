<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <link rel="stylesheet" href="/common/jquery-ui-1.10.2/css/smoothness/jquery-ui.css" />
    <script src="/common/jquery-1.9.1.js"></script>
    <script src="/common/jquery-ui-1.10.2/js/jquery-ui.js"></script>
    <script src="/common/jquery.cookie.js"></script>
    <script src="/static/js/ba-debug.js"></script>
    <script src="/static/js/reconnecting-websocket.js"></script>

	<script type="text/javascript" src="http://craftyjs.com/release/0.4.2/crafty-min.js"></script>
    <script src='/static/js/common.js'></script>
	<script type="text/javascript" src="game.js"></script>

    <link rel="stylesheet" type="text/css" href="/static/css/shadmin.css">
    <link rel="stylesheet" type="text/css" href="/static/css/shgame.css">

	<title>Connect 4</title>
	<style>
        .gameInfoDiv {
            float:left;
            margin-left: 20px;
            width: 200px;
        }

        #cr-stage {
            float: left;
            margin:5px auto;
            border:5px solid black;
        }
	</style>
    <script language="javascript">
        var Env = {{{EnvJson}}};

        Env.gameId = "0";
        var pgameId = getURLParameter("gameId");
        if (pgameId != 'null') {
            Env.gameId = pgameId.toString();
        }

        function shellyInit() {
            sendCmd("live.game", {gameId: Env.gameId, status: "on"});
            sendCmd("game.join", {gameId: Env.gameId});
        }

        function fillRow(rowNum, board) {
            for (var i = 0; i < 7; i++) {
                gBoard[i][rowNum] = board[i][rowNum];
                if(board[i][rowNum] === 1) {
                    addPiece("red", i);
                } else if (board[i][rowNum] === 0) {
                    addPiece("yellow", i);
                }
            }
            if(rowNum < 6) {
                setTimeout(function () { fillRow(rowNum+1, board)}, 500);
            }
        }

        function setWhoTurn(uid) {
            if (uid === Env.user.oid) {
                $("#whoTurn").text("yours");
            } else {
                $("#whoTurn").text(Env.game.players[uid].name);
            }
        }

        function processEvent(msg) {
            if (msg.event === "event.game.update") {
                var move = msg.data.move;
                if (Env.user.oid !== msg.data.uid) { // ignore our own moves
                    gBoard[move.x][move.y] = msg.data.color;
                    addPiece((msg.data.color===0 ? "red" : "yellow"), move.x);
                }
            }
            if (msg.event === "event.game.turn.next") {
                setWhoTurn(msg.data.whoTurn);
            }
            if (msg.event === "event.game.join") {
                var board = msg.data.state.board;
                Env.game = msg.data;
                setWhoTurn(msg.data.whoTurn);
                fillRow(0, board);
            }
        }

        function addPiece(color, column) {
            console.log("add", color, column);
            var current = Crafty.e("2D, Canvas, gravity, stopper, " + color).attr({x: column * 64, y: 0});
            current.gravity("stopper")
        }

        function pieceDrop(turn, column, row) {
            // 1===red, 0===yellow
            sendCmd("game.turn", {gameId: Env.gameId, move: {x: column, y: row}});
        }

        $(init);
        function init() {
            $("#shSystem").text("Example");
            $("#shSubTitle").text("Connect 4");

            $(".tictac").click(function () {
                var id = $(this).attr("id");
                var x = id.slice(1, 2);
                var y = id.slice(3, 4);
                sendCmd("game.turn", {gameId: Env.gameId, move: {x: x, y: y}})
            });

            $("#gameReset").click(function () {
                sendCmd("game.reset", {gameId: Env.gameId});
            });

            ws.connect(Env.socketUrl);

            initGame();
            Crafty.scene("game");
        }
    </script>
</head>
<body>
{{> header}}
{{> gameNav}}
<div id="cr-stage"></div>

<div class="gameInfoDiv gameBoxDiv">
    <div class="gameBoxHeaderDiv" style="">Game Info</div>
    <div class="gameBoxInnerDiv">
        <div>your color: <span id="playerColor">unknown</span></div>
        <div>whose turn: <span id="whoTurn"></span></div>
        <div>winner: <span id="gameWinner">none</span></div>
        <div>playing: <span id="gamePlaying"></span></div>
        <button id="gameReset" style="float:right">reset</button>
    </div>
</div>
<div class="gameInfoDiv gameBoxDiv">
    <div class="gameBoxHeaderDiv" style="">Players</div>
    <div class="gameBoxInnerDiv">
        <div>foo</div>
    </div>
</div>
<div style="clear:both"></div>
<div class="messageLogDiv gameBoxDiv">
    <div class="gameBoxHeaderDiv"<b>Message Log</b></div>
<div id="messageLog" class="gameBoxInnerDiv" readonly></div>
</div>
{{> footer}}
</body>
</html>