<html xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html">
<head>
<title>Lobby</title>
    <link rel="stylesheet" href="/common/jquery-ui-1.10.2/css/smoothness/jquery-ui.css" />
    <script src="/common/jquery-1.9.1.js"></script>
    <script src="/common/jquery-ui-1.10.2/js/jquery-ui.js"></script>
    <script src="/common/jquery.cookie.js"></script>
    <script src="/static/js/ba-debug.js"></script>
    <script src="/static/js/reconnecting-websocket.js"></script>
    <script src="/static/js/fastclick.js"></script>
    <script src="/static/js/common.js"></script>

    <link rel="stylesheet" type="text/css" href="/static/css/shadmin.css">
    <link rel="stylesheet" type="text/css" href="/static/css/shgame.css">

<style>
    .userBtn {
        font-size: 10px;
    }

    .playAnyoneDiv {
        width: 220px;
    }
    .lobbyUsersDiv {
        width: 220px;
    }
    #userList {
        height: 307px;
    }
    #liveToggle {
        font-size: 10px;
    }

    .suggestedUsersDiv {
        float: left;
        width: 220px;
    }
    #suggestedUserList {
        height: 358px;
    }

    .challengesDiv {
        float: left;
        width: 225px;
    }
    #challengeList {
        height: 358px;
    }

    .userPictImg {
        width: 30px;
        height: 30px;
    }

    .userAttr {
        margin-left: 5px;
    }
</style>

<script language="javascript">
var Env = {{{EnvJson}}};

function addChallenge(chId, challenge) {
    if ($("#" + chId.replace(":", "\\:")).length !== 0) {  // must escape the : in the id for select
        return;
    }
    var $newChallenge = $("#challengeTemplate").clone();
    $newChallenge.find("#challengerName").text(challenge.data.name);
    $newChallenge.find("#challengerAge").text(challenge.data.age);
    $newChallenge.find("#challengerGender").text(challenge.data.gender);
    $newChallenge.find("#challengeGame").text(challenge.game);
    $newChallenge.find("#challengerPict").attr("src", challenge.data.pict);
    $newChallenge.addClass("activeChallenge");
    $newChallenge.attr("id", chId);
    $newChallenge.css("display", "block");

    $newChallenge.find("#challengeAccept").attr("chId", chId);
    $newChallenge.find("#challengeDecline").attr("chId", chId);

    $newChallenge.find("#challengeAccept").click(function () {
        var chId =$(this).attr("chId");
        console.log("accept", chId);
        sendCmd("challenge.accept", {chId: chId});
        $("#" + chId.replace(":", "\\:")).remove();
    });
    $newChallenge.find("#challengeDecline").click(function () {
        var chId =$(this).attr("chId");
        console.log("decline", chId);
        sendCmd("challenge.decline", {chId: chId});
        $("#" + chId.replace(":", "\\:")).remove();
    });

    $("#challengeList").append($newChallenge);
}

function setChallengeInfo(challengeList) {
    $(".activeChallenge").remove();
    for (chId in challengeList.recieved) {
        addChallenge(chId, challengeList.recieved[chId]);
    }
}

function removeUser(listName, uid) {
    $(".userId" + listName + uid).remove();
}

function addUser(listName, profile) {
    if ($(".userId" +listName + profile.uid).size() > 0) {
        return;
    }
    var $newGame = $("#userTemplate").clone();
    $newGame.find("#userName").text(profile.name);
    $newGame.find("#userName").addClass("playerName" + profile.uid);
    $newGame.find("#userPict").attr("src", profile.pict);
    $newGame.find("#userGender").text(profile.gender);
    $newGame.find("#userAge").text(profile.age);
    $newGame.addClass("activeUser" + listName);
    $newGame.addClass("userId" + listName + profile.uid);
    $newGame.attr("uid", profile.uid);
    $newGame.css("display", "block");

    if (profile.uid === Env.user.oid) {
        $newGame.find("#userName").text("me");
        $newGame.find("#userChallenge").css("display", "none");
    }

    $newGame.find("#userChallenge").click(function () {
        var toUid =$(this).parent().attr("uid");
        sendCmd("challenge.make", {toUid: toUid, game: "connect4"});

    });

    // userList or suggestList
    $("#" + listName).append($newGame);
}

function setUserInfo(listName, profiles) {
    $(".activeUser" + listName).remove();
    for (uid in profiles) {
        addUser(listName, profiles[uid]);
    }
}

function processEvent(res, from) {
    if (typeof(res.event) == "undefined") {
        log(from, "error", "old message: " + JSON.stringify(res));
        return;
    }
    if (res.event == "error") {
        showError(res.message);
        log(from, "error", JSON.stringify(res));
        return;
    }
    if (res.event == "heartbeat") {
        return;
    }
    if (res.event == "channel.user") {
        if (res.data.status === "on") {
            addUser("userList", res.data);
        } else {
            removeUser("userList", res.data.uid);
        }
        return;
    }
    if (res.event == "channel.message") {
        for (var i=0; i<res.data.bank.length; i++) {
            addMessage(res.data.channel, res.data.bank[i]);
        }
        return;
    }
    if (res.event == "channel.send") {
        return;
    }
    if (res.event == "suggest.list") {
        setUserInfo("suggestedUserList", res.data);
        return;
    }
    if (res.event == "challenge.list") {
        setChallengeInfo(res.data);
        return;
    }
    if (res.event == "challenge.send") {
        addChallenge(res.data.chId, res.data.challenge);
        return;
    }
    if (res.event == "challenge.start") {
        gameInit(res.data.gameName, res.data.gameId);
        return;
    }
    if (res.event == "match.made") {
        gameInit(res.data.gameName, res.data.gameId);
        return;
    }
    if (res.event == "match.add") {
        $("#dialog").dialog();
        return;
    }
    if (res.event == "system.connInfo") {
        console.log("wid:", res.data.wid);
        return;
    }
    log(from, "unknown-event", JSON.stringify(res));
}

function shellyInit() {
    sendRaw({session: Env.session,
        batch: [{cmd: "system.connInfo"},
            {cmd: "challenge.list"},
            {cmd: "suggest.list", limit: 10},
            {cmd: "channel2.add", channel: "lobby:0"}
        ]});
}

$(init);
function init() {
    $("#shSystem").text("Example");
    $("#shSubTitle").text("Lobby");

    window.addEventListener("load", function () {
        new FastClick(document.body);
    }, false);

    $("#gameTicTacToe").click(function () {
        sendCmd("match.add", {name: "tictactoe"});
        $("#dialog").dialog();
    });
    $("#gameConnect4").click(function () {
        sendCmd("match.add", {name: "connect4"});
    });
    $("#liveToggle").click(function () {
        if ($(this).attr("status") == "on") {
            $(this).text("go online");
            $(this).attr("status", "off");
            sendCmd("channel2.remove", {channel: "lobby:0"});
        } else {
            $(this).text("go offline");
            $(this).attr("status", "on");
            sendCmd("channel2.add", {channel: "lobby:0"});
        }
    });

    commInit();
    messageInit("lobby:0");

    ws.connect(Env.socketUrl);
}
</script>
</head>
<body>
{{> header}}
{{> gameNav}}
{{> errorBox }}

<div style="float:left; margin-bottom: 5px;">
    <div class="playAnyoneDiv gameBoxDiv">
        <div class="gameBoxHeaderDiv">Random Player</div>
        <div id="playNowList" class="gameBoxInnerDiv">
            <button id="gameTicTacToe">Tic Tac Toe</button>
            <button id="gameConnect4">Connect 4</button>
        </div>
    </div>
    <div class="lobbyUsersDiv gameBoxDiv">
        <div class="gameBoxHeaderDiv">Online Players
            <button id="liveToggle" style="float:right" status="on">go offline</button>
        </div>
        <div id="userList" class="gameBoxInnerDiv">
            <div id="userTemplate" style="display:none;">
                <img id="userPict" class="userPictImg" src="/static/images/dflt-avatar.png"/>
                <span id="userName"></span>
                <span id="userGender"></span>
                <span id="userAge"></span>
                <button id="userChallenge" style="float:right">challenge</button>
                <div style="clear:both"></div>
            </div>
        </div>
    </div>
</div>

<div class="suggestedUsersDiv gameBoxDiv">
    <div class="gameBoxHeaderDiv">Suggested Opponents</div>
    <div id="suggestedUserList" class="gameBoxInnerDiv">
        <div id="suggestedUserTemplate" style="display:none;">
            <span id="suggestedUserName"></span>
            <button id="suggestedUserOffer" style="float:right">challenge</button>
            <div style="clear:both"></div>
        </div>
    </div>
</div>

<div class="challengesDiv gameBoxDiv">
    <div class="gameBoxHeaderDiv">Challenges</div>
    <div id="challengeList" class="gameBoxInnerDiv">
        <div id="challengeTemplate" style="display:none;">
            <div style="width: 30px; float:left">
                <img id="challengerPict" class="userPictImg" src="/static/images/dflt-avatar.png"/>
            </div>
            <div style="width:190px; float:left">
                <div>
                    <span id="challengerName" class="userAttr" style="float:left">player</span>
                    <button id="challengeAccept" class="UserBtn" style="float:right">accept</button>
                    <button id="challengeDecline" class="UserBtn" style="float:right">decline</button>
                </div>
                <div style="clear:both"></div>
                <div>
                    <span id="challengerGender" class="userAttr" style="float:left">U</span>
                    <span id="challengerAge" class="userAttr" style="float:left">0</span>
                    <span id="challengeGame" class="userAttr" style="float:right">unknown</span>
                </div>
            </div>
            <div style="clear:both"></div>
        </div>
    </div>
</div>

<div style="clear:both"></div>

<div class="messageLogDiv gameBoxDiv">
    <div class="gameBoxHeaderDiv">Messages</div>
    <div class="gameBoxInnerDiv" readonly>
        <div id="messageLog" style="overflow: auto" readonly></div>
        <div class="gameBoxFooterDiv">
            <input id="chatInput" type="text" style="width: 90%;"></input>
            <button id="sendChat" style="float:right;">send</button>
        </div>
    </div>
</div>

<div class="commLogDiv gameBoxDiv">
    <div class="gameBoxHeaderDiv">Comm Log<button id="showHideLog" style="float:right;">+</button></div>
    <div id="commLog" class="gameBoxInnerDiv" readonly></div>
</div>

<!-- popup dialog that shows waiting for match -->
<style>
    .waitOptionDiv {
        margin: 10px;
    }
    .ui-dialog-titlebar {
        display: none;
    }
</style>
<div id="dialog" style="display:none" title="Ready to Play">
    <div class="waitOptionDiv">waiting for user to join you...</div>
    <div class="waitOptionDiv">Or give us your email and we will notify you.</div>
    <div class="waitOptionDiv">Or come back later.</div>
</div>

<!-- modal dialog for server disconnected -->
<div id="serverConnectDlg" style="height: 150px; display:none">
    <div class="waitOptionDiv">Lost contact with server.</div>
    <div class="waitOptionDiv">Reconnecting...</div>
</div>

{{> footer}}
</body>
</html>