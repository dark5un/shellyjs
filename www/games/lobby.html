<html xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html">
<head>
<title>Lobby</title>
    <link rel="stylesheet" href="/common/jquery-ui-1.10.2/css/smoothness/jquery-ui.css" />
    <script src="/common/jquery-1.9.1.js"></script>
    <script src="/common/jquery-ui-1.10.2/js/jquery-ui.js"></script>
    <script src="/common/jquery.cookie.js"></script>
    <script src="/static/js/ba-debug.js"></script>
    <script src="/static/js/reconnecting-websocket.js"></script>
    <script src="/static/js/fastclick.js"></script>
    <script src="/static/js/common.js"></script>

    <link rel="stylesheet" type="text/css" href="/static/css/shadmin.css">
    <link rel="stylesheet" type="text/css" href="/static/css/shgame.css">

<style>
    .playAnyoneDiv {
        width: 220px;
    }

    .lobbyUsersDiv {
        width: 220px;
    }
    #userList {
        height: 307px;
    }
    #liveToggle {
        font-size: 10px;
    }

    .gameTurnsGroup {  /* container div for turns/done lists */
        float:left;
        width:340;
    }
    .gameListDiv {  /* all game turns/done lists */
        width: 340px;
    }
    #gameMyTurnList {
        height: 100px;
    }
    #gameOppTurnList {
        height: 100px;
    }
    #gameDoneList {
        height: 100px;
    }
</style>

<script language="javascript">
var Env = {{{EnvJson}}};

function setMatchInfo(matchList) {
    $(".activeMatch").remove();
    for (gameName in matchList) {
        var $newGame = $("#matchTemplate").clone();
        $newGame.find("#matchName").text(gameName);
        $newGame.find("#matchTime").text(prettyDate(matchList[gameName].lastCreated));
        $newGame.attr("gameName", gameName);
        $newGame.addClass("activeMatch");
        $newGame.css("display", "block");

        $("#matchList").append($newGame);
    }
}

function removeUser(uid) {
    $(".userId" + uid).remove();
}

function addUser(profile) {
    if ($(".userId" + profile.uid).size() > 0) {
        return;
    }
    var $newGame = $("#userTemplate").clone();
    $newGame.find("#userName").text(profile.name);
    $newGame.find("#userName").addClass("playerName" + profile.uid);
    $newGame.addClass("userId" + profile.uid);
    $newGame.addClass("activeUser");
    $newGame.attr("uid", profile.uid);
    $newGame.css("display", "block");

    $newGame.find("#userOffer").click(function () {
        alert("not implemented");
//                var gameId = $(this).parent().attr("gameId");
    });

    $("#userList").append($newGame);
}

function processEvent(res, from) {
    if (typeof(res.event) == "undefined") {
        log(from, "error", "old message: " + JSON.stringify(res));
        return;
    }
    if (res.event == "error") {
        showError(res.message);
        log(from, "error", JSON.stringify(res));
        return;
    }
    if (res.event == "heartbeat") {
        return;
    }
    if (res.event == "game.playing") {
        setMyGames(res.data);
        return;
    }
    if (res.event == "game.turn.next") {
        setWhoTurn(res.data.gameId, res.data.whoTurn, res.data);
        return;
    }
    if (res.event == "channel.user") {
        if (res.data.status === "on") {
            addUser(res.data);
        } else {
            removeUser(res.data.uid);
        }
        return;
    }
    if (res.event == "channel.message") {
        for (var i=0; i<res.data.bank.length; i++) {
            addMessage(res.data.channel, res.data.bank[i]);
        }
        return;
    }
    if (res.event == "channel.send") {
        return;
    }
    if (res.event == "match.stats") {
        setMatchInfo(res.data);
        return;
    }
    if (res.event == "match.made") {
        gameInit(res.data.gameName, res.data.gameId);
        return;
    }
    if (res.event == "match.add") {
        return;
    }
    log(from, "unknown-event", JSON.stringify(res));
}

function shellyInit() {
    /*
    sendCmd("game.playing");
    sendCmd("match.stats");
    sendCmd("channel.add", {channel: "lobby:0"});
    sendCmd("channel.add", {channel: "turns:" + Env.user.oid});
    sendCmd("channel.add", {channel: "matches:" + Env.user.oid});
    */

    sendRaw({session: Env.session,
        msgs: [{cmd: "game.playing"},
            {cmd: "match.stats"},
            {cmd: "channel.add", channel: "lobby:0"},
            {cmd: "channel.add", channel: "turns:" + Env.user.oid},
            {cmd: "channel.add", channel: "matches:" + Env.user.oid}
        ]});
}

$(init);
function init() {
    $("#shSystem").text("Example");
    $("#shSubTitle").text("Lobby");

    window.addEventListener("load", function () {
        new FastClick(document.body);
    }, false);

    $("#gameTicTacToe").click(function () {
        sendCmd("match.add", {name: "tictactoe"});
        $("#dialog").dialog();
    });
    $("#gameConnect4").click(function () {
        sendCmd("match.add", {name: "connect4"});
        $("#dialog").dialog();
    });
    $("#liveToggle").click(function () {
        if ($(this).attr("status") == "on") {
            $(this).text("go online");
            $(this).attr("status", "off");
            sendCmd("channel.remove", {channel: "lobby:0"});
        } else {
            $(this).text("go offline");
            $(this).attr("status", "on");
            sendCmd("channel.add", {channel: "lobby:0"});
        }
    });

    commInit();
    messageInit("lobby:0");

    ws.connect(Env.socketUrl);
}
</script>
</head>
<body>
{{> header}}
{{> gameNav}}

<div id="errorMessage" style="display:none;width:100%;background:pink;color:red;">error</div>

<div style="float:left; margin-bottom: 5px;">
    <div class="playAnyoneDiv gameBoxDiv">
        <div class="gameBoxHeaderDiv">Play Anyone Now</div>
        <div id="playNowList" class="gameBoxInnerDiv">
            <button id="gameTicTacToe">Tic Tac Toe</button>
            <button id="gameConnect4">Connect 4</button>
        </div>
    </div>
    <div class="lobbyUsersDiv gameBoxDiv">
        <div class="gameBoxHeaderDiv">Users in Lobby
            <button id="liveToggle" style="float:right" status="on">go offline</button>
        </div>
        <div id="userList" class="gameBoxInnerDiv">
            <div id="userTemplate" style="display:none;">
                <span id="userName">open-game-0</span>
                <button id="userOffer" style="float:right">offer</button>
                <div style="clear:both"></div>
            </div>
        </div>
    </div>
</div>

<div class="gameTurnsGroup">
<div class="gameListDiv gameBoxDiv">
    <div class="gameBoxHeaderDiv">Your Turn</div>
    <div id="gameMyTurnList" class="gameBoxInnerDiv">
        <div id="gameTemplate" style="display:none;">
            <span id="gameName">game-0</span>
            <span id="gameTurn"></span>
            <button style="float:right;" id="myGameRemove">remove</button>
            <button style="float:right;" id="myGameJoin">play</button>
            <div style="clear:both"></div>
        </div>
    </div>
</div>

<div class="gameListDiv gameBoxDiv">
    <div class="gameBoxHeaderDiv" style="text-align: right;">Their Turn</div>
    <div id="gameOppTurnList" class="gameBoxInnerDiv">
    </div>
</div>

<div class="gameListDiv gameBoxDiv">
    <div class="gameBoxHeaderDiv" style="text-align: center">Finished Games</div>
    <div id="gameDoneList" class="gameBoxInnerDiv">
    </div>
</div>
 </div>

<div style="clear:both"></div>

<div class="messageLogDiv gameBoxDiv">
    <div class="gameBoxHeaderDiv">Messages</div>
    <div class="gameBoxInnerDiv" readonly>
        <div id="messageLog" style="overflow: auto" readonly></div>
        <div class="gameBoxFooterDiv">
            <input id="chatInput" type="text" style="width: 90%;"></input/>
            <button id="sendChat" style="float:right;">send</button>
        </div>
    </div>
</div>

<div class="commLogDiv gameBoxDiv">
    <div class="gameBoxHeaderDiv">Comm Log<button id="showHideLog" style="float:right;">+</button></div>
    <div id="commLog" class="gameBoxInnerDiv" readonly></div>
</div>


<!-- popup dialog that shows waiting for match -->
<div class="matchListDiv" style="display:none;">
    <div class="gameBoxHeaderDiv">Game Activity</div>
    <div id="matchList" class="gameBoxInnerDiv">
        <div id="matchTemplate" style="display:none;">
            <span id="matchName">game0</span> =
            <span id="matchTime">time</span>
        </div>
    </div>
</div>


<style>
    .waitOptionDiv {
        margin: 10px;
    }
</style>
<div id="dialog" style="display:none" title="Ready to Play">
    <div class="waitOptionDiv">waiting for user to join you...</div>
    <div class="waitOptionDiv">Or give us your email and we will notify you.</div>
    <div class="waitOptionDiv">Or come back later.</div>
</div>

{{> footer}}
</body>
</html>