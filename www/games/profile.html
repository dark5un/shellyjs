<html xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html"
      xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html">
<head>
<title>Lobby</title>
    <link rel="stylesheet" href="/common/jquery-ui-1.10.2/css/smoothness/jquery-ui.css" />
    <script src="/common/jquery-1.9.1.js"></script>
    <script src="/common/jquery-ui-1.10.2/js/jquery-ui.js"></script>
    <script src="/common/jquery.cookie.js"></script>
    <script src="/static/js/ba-debug.js"></script>
    <script src="/static/js/reconnecting-websocket.js"></script>
    <script src="/static/js/fastclick.js"></script>
    <script src="/static/js/common.js"></script>

    <link rel="stylesheet" type="text/css" href="/static/css/shadmin.css">
    <link rel="stylesheet" type="text/css" href="/static/css/shgame.css">

    <script language="javascript">
var Env = {{{EnvJson}}};

function resetProfileSpans() {
    var saveData = {};
    $(".profileEditSpan").replaceWith(function () {
        var editId = $(this).attr("id");
        var value = $(this).val();
        saveData[editId] = value;
        Env.user[editId] = value;
        $span = $("<span/>");
        $span.attr("id", editId);
        $span.addClass("profileEditSpan");
        $span.text(Env.user[editId]);
        return $span;
    });
    $("#editProfile").css("display", "block");
    $("#saveProfile").css("display", "none");
    $("#cancelProfile").css("display", "none");
    return saveData;
}

function updateProfile(user) {
    if(typeof (user) === "object") {
        Env.user = user;
    }

    if (typeof (Env.user.email) !== "undefined" && Env.user.email.length > 0) {
        $(".anonymousDiv").css("display", "none");
        $("#emailRow").css("display", "");
    } else {
        $(".anonymousDiv").css("display", "block");
        $("#emailRow").css("display", "none");
    }
    $("#email").text(Env.user.email);
}

$(init);
function init() {
    $("#shSystem").text("Example");
    $("#shSubTitle").text("Profile");

    commInit();

    window.addEventListener("load", function () {
        new FastClick(document.body);
    }, false);

    updateProfile();

    $("#saveProfile").css("display", "none");
    $("#cancelProfile").css("display", "none");

    $("#editProfile").click(function () {
        $(".profileEditSpan").replaceWith(function () {
            var editId = $(this).attr("id");
            $input = $("<input/>");
            $input.attr("id", editId);
            $input.addClass("profileEditSpan");
            $input.val(Env.user[editId]);
            return $input;
        });
        $("#editProfile").css("display", "none");
        $("#saveProfile").css("display", "block");
        $("#cancelProfile").css("display", "block");
    });

    $("#cancelProfile").click(function () {
        resetProfileSpans();
    });

    $("#saveProfile").click(function () {
        var saveData = resetProfileSpans();
        console.log(saveData);
        var res = sendRestCmd("user.set", {user: saveData}, function (error, data) {
            if(!error) {
                $("#shUserNameSpan").text(data.data.name);
            }
        });
    });

    $("#registerNow").click(function () {
        hideError();

        var regData = {};
        regData.email = $("#regEmail").val();
        regData.password = $("#regPassword").val();
        if (regData.password !== $("#regPasswordVerify").val()) {
            showError("passwords do not match");
            return;
        }
        console.log(regData);
        var res = sendRestCmd("reg.upgrade", regData, function (error, data) {
            if(!error) {
                console.log(data);
                if (data.event === "error") {
                    showError(data.message);
                } else {
                    updateProfile(data.data);
                }
            }
        });
    });
}
</script>
    <style>
        .anonymousDiv {
            width: 500px;
        }
        .profileInfoDiv {
            width: 500px;
        }
        #profileContent {
            height: 200px;
        }

        .userTd {
            text-align: right;
        }
    </style>
</head>
<body>
{{> header}}
{{> gameNav}}

<div id="errorMessage" style="display:none;width:100%;background:pink;color:red;">error</div>

<div class="gameBoxDiv anonymousDiv" style="float:left;">
    <div class="gameBoxHeaderDiv">Upgrade Account</div>
    <div class="gameBoxInnerDiv">
        <p>You are currently using an anonymous account.</p>
        <p>Your information will not transfer to other devices and may be lost if you reset your browser or device.</p>
        <p>Please register below to preserve your data and play from any device.</p>
        <table>
            <tr><td class="userTd">email:</td></td><td><input type="text" id="regEmail"></input></td></tr>
            <tr><td class="userTd">password:</td></td><td><input type="password" id="regPassword"></input></td></tr>
            <tr><td class="userId">verify password:</td></td><td><input type="password" id="regPasswordVerify"></input></td></tr>
        </table>
        <button id="registerNow" style="float:right">register</button>
    </div>
</div>

<div class="profileInfoDiv gameBoxDiv" style="float:left;">
    <div class="gameBoxHeaderDiv">Profile Information</div>
    <div id="profileContent" class="gameBoxInnerDiv">
        <table>
            <tr><td class="userTd">user id:</td><td><span id="uid">{{Env.user.oid}}</span></td></tr>
            <tr id="emailRow"><td class="userTd">email:</td><td><span id="email">{{Env.user.email}}</span></td></tr>
            <tr><td class="userTd">name:</td><td><span id="name" class="profileEditSpan">{{Env.user.name}}</span></td></tr>
            <tr><td class="userTd">gender:</td><td><span id="gender" class="profileEditSpan">{{Env.user.gender}}</span></td></tr>
            <tr><td class="userTd">age:</td><td><span id="age" class="profileEditSpan">{{Env.user.age}}</span></td></tr>
            <tr><td class="userTd">token:</td><td><span id="token">{{Env.token}}</span></td></tr>
        </table>
        <button id="saveProfile" style="float:right">save</button>
        <button id="editProfile" style="float:right">edit</button>
        <button id="cancelProfile" style="float:right">cancel</button>
    </div>
</div>
<div style="clear:both"></div>

<div class="commLogDiv gameBoxDiv">
    <div class="gameBoxHeaderDiv">Comm Log<button id="showHideLog" style="float:right;">+</button></div>
    <div id="commLog" class="gameBoxInnerDiv" readonly></div>
</div>

{{> footer}}
</body>
</html>