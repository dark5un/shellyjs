<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Shelly - Core</title>
    <link rel="stylesheet" href="/common/jquery-ui-1.10.2/css/smoothness/jquery-ui.css" />
    <script src="/common/jquery-1.9.1.js"></script>
    <script src="/common/jquery-ui-1.10.2/js/jquery-ui.js"></script>
    <link rel="stylesheet" type="text/css" href="/static/jsoneditor-2.0.0/jsoneditor.css">
    <script type="text/javascript" src="/static/jsoneditor-2.0.0/jsoneditor.js"></script>
    <script src="/static/js/ba-debug.js"></script>
    <link rel="stylesheet" type="text/css" href="/static/css/shadmin.css">
    <style>
        .ui-widget {
            font-family: Courier;
        }
        .coreAccordion {
            width: 125px;
            font-size: 14px;
        }
        .setFunctionDiv:hover {
            color: blue;
            text-decoration: underline;
            cursor: pointer;
        }
        #inputEditor {
            width: 600px;
            height: 150px;
            margin-left: 5px;
        }
        #outputEditor {
            width: 600px;
            height: 400px;
            margin-left: 5px;
        }

        div.jsoneditor {
            border: 1px solid #8da95f;
        }

        .jsoneditor .menu {
            background-color: #8da95f;
            background-color: hsla(83, 30.0813%, 65%, 1.0000);
            border-bottom: 1px solid #8da95f;
        }
        .jsoneditor .menu button {
            border: 1px solid #8da95f;
            background-color: hsla(83, 30.0813%, 80%, 1.0000);
        }
    </style>
    <script>
        var Env = {{{EnvJson}}};

        var gInputEdit = null;
        var gOutputEdit = null;
        var gLastModule = "game";
        var gLastFunction = "create";

        function createModule(name, m)
        {
            debug.info("create module:", name, m);

            // create the module
            var $section = $("#accordion").append('<h3><a href="#">' + name + '</a></h3>');
            var $functionDiv = $("<div></div>");
            // list the functions
            for (fkey in m.functions) {
                $functionDiv.append("<div class='setFunctionDiv' module='" + name + "' function='" + fkey + "'>" + fkey + "</div>");
//                        $functionLink.text(fkey);
//                        $functionLink.attr("href", "function/"+mkey+"/"+fkey);
//                        $newFunction.css("display", "block");
//                        $newModule.append($newFunction);
            }
            $section.append($functionDiv);
        }
        function initParams(module, func)
        {
            console.log(module, func);
            var cmd = module + "." + func;
            var input = {cmd:cmd};
            if (cmd!='reg.login' && cmd!='reg.check' && cmd!='reg.create')
            {
                input.session = Env.session;
            }

            $('#moduleName').text(module);
            $('#functionName').text(func);
            var funcInfo = Env.modules[module].functions[func];
            $('#functionDescription').text(funcInfo.desc);
            $('#functionSecurity').text(JSON.stringify(funcInfo.security));
            var paramInfo = "";
            console.log(funcInfo);
            for (key in funcInfo.params)
            {
                var dtype = funcInfo.params[key].dtype;
                paramInfo += key + "=" + dtype;
                if(typeof(funcInfo.params[key].optional) !== 'undefined'
                        && funcInfo.params[key].optional)
                {
                    paramInfo += " (optional)";
                }
                paramInfo += "<br>";
                if(dtype == 'object') {
                    input[key] = {};
                } else if (dtype == 'array') {
                    input[key] = [];
                } else if (dtype == 'number') {
                    input[key] = 0;
                } else if (dtype == 'string') {
                    input[key] = '';
                }
            }
            if(paramInfo.length==0)
            {
                paramInfo = "(none)";
            }
            $('#functionParams').html(paramInfo);
            gInputEdit.set(input);
            gOutputEdit.set();
        }

        $(init);
        function init() {
            $("#shSubTitle").text("Core Modules");

            for (mkey in Env.modules) {
                createModule(mkey, Env.modules[mkey]);
            }
            $("#accordion").accordion({heightStyle: "content", collapsible: true });

            var inputContainer = document.getElementById("inputEditor");
            gInputEdit = new jsoneditor.JSONFormatter(inputContainer);
            var outputContainer = document.getElementById("outputEditor");
            gOutputEdit = new jsoneditor.JSONFormatter(outputContainer);

            initParams(gLastModule, gLastFunction);

            $('.setFunctionDiv').click(function(event) {
                gLastModule = $(this).attr("module");
                gLastFunction = $(this).attr("function");
                console.log(gLastModule, gLastFunction);
                initParams(gLastModule, gLastFunction);
                event.stopPropagation();
                return false;
            });

            $('#callFunction').click(function() {
                try {
                    var input = gInputEdit.get();
                } catch (e) {
                    alert("error parsing input: " + e.message);
                }
                console.log(JSON.stringify(input));
                $.ajax({
                    type: "POST",
                    url: Env.restUrl,
                    async: false,
                    contentType: "application/json",
                    dataType: "json",
                    data: JSON.stringify(input),
                    success: function (data, status) {
                        gOutputEdit.set(data);
                    },
                    error: function (xhr, status, err) {
                        console.log(xhr.responseText);
                        gOutputEdit.set(JSON.parse(xhr.responseText));
                    }
                })
            });
            $('#resetFunction').click(function() {
                initParams(gLastModule, gLastFunction)
            });


        }
    </script>

</head>
<body>
{{> header}}
{{> adminNav}}

<div id="accordion" class="coreAccordion" style="float:left">
</div>
<div style="float:left;">
<table border="0">
    <tr>
        <td class="nameCell">module:</td><td><span id="moduleName">{module_name}</span>.<span id="functionName">{function_name}</span></td>
    </tr>
    <tr>
        <td class="nameCell" style="vertical-align: text-top;">params:</td><td><div id="functionParams">{function_params}</div></td>
    </tr>
    <tr>
        <td class="nameCell">description:</td><td><div id="functionDescription">{function_description}</div></td>
    </tr>
    <tr>
        <td class="nameCell">security:</td><td><div id="functionSecurity">{function_security}</div></td>
    </tr>
</table>
<div id="inputEditor"></div>
<div>
    <td><button id="callFunction">call function</button></td>
    <td><button id="resetFunction" style="float:right;">reset</button></td>
</div>
<div id="outputEditor"></div>
</div>

{{> footer}}
</body>
</html>