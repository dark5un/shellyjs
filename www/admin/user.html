<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Shelly User Manager</title>
    <link rel="stylesheet" href="/common/jquery-ui-1.10.2/css/smoothness/jquery-ui.css" />
    <script src="/common/jquery-1.9.1.js"></script>
    <script src="/common/jquery-ui-1.10.2/js/jquery-ui.js"></script>
    <link rel="stylesheet" type="text/css" href="/static/css/shadmin.css">
    <script src="/static/js/common.js"></script>
    <style>
        pre {
            margin: 0px;
        }
        .lookupUserDiv {
            width: 450px;
        }
        .emailInput,
        .tokenInput,
        .uidInput {
            width: 245px;
        }
        .btn-div {
            width: 450px;
        }
        .edit-user-btn,
        .display-user-btn {
            float: right;
        }
        #errorMsg {
            border: 1px solid;
            padding:15px 10px 15px 50px;
            background-repeat: no-repeat;
            background-position: 10px center;
            display: none;
            margin: 10px auto;
            width: 400px;
            color: #D8000C;
            background-color: #FFBABA;
            background-image: url("/static/images/toolbar/error.png");
        }

    </style>
    <script>
        var Env = {{{EnvJson}}};

        function userValue(key) {
            if(typeof(Env.user[key]) === "object") {
                return JSON.stringify(Env.user[key]);
            } else {
                return Env.user[key];
            }
        }

        function showUser(user) {
            $(".user-key-value-div").remove();
            Env.user = user;
            for (key in user) {
                $newKv = $("#keyValueTpl").clone();
                $newKv.addClass("user-key-value-div");
                $newKv.css("display", "block");
                $newKv.find("#key").text(key);
                if (key !== "oid" && key !== "email" && key !== "created" && key !== "modified") {
                    $newKv.find("#value").addClass("value-edit-span");
                    $newKv.find("#value").attr("editId", key);
                }
                $newKv.find("#value").text(userValue(key));
                $("#userEditor").append($newKv);
            }
            $(".edit-user-btn").css("display", "none");
            $(".display-user-btn").css("display", "block");
        }

        function editCurrent() {
            $(".value-edit-span").replaceWith(function () {
                var editId = $(this).attr("editId");
                if (typeof(editId) === "undefined") return;
                $input = $("<input/>");
                $input.attr("editId", editId);
                $input.addClass("value-edit-span");
                $input.val($(this).text());
                return $input;
            });
            $(".edit-user-btn").css("display", "block");
            $(".display-user-btn").css("display", "none");
        }

        function resetCurrent(saved) {
            var saveData = {};
            $(".value-edit-span").replaceWith(function () {
                var editId = $(this).attr("editId");
                if (typeof(editId) === "undefined") return;
                var value = $(this).val();
                if (value !== userValue(editId)) {
//                    if (editId !== "roles") {
                    if (typeof(Env.user[editId]) !== "object") {
                        saveData[editId] = value;
                    } else {
                        saveData[editId] = JSON.parse(value);
                    }
                }
                $span = $("<span/>");
                $span.attr("editId", editId);
                $span.addClass("value-edit-span");
                if (saved) {
                    Env.user[editId] = value;
                    $span.text(value);
                } else {
                    $span.text(userValue(editId));
                }
                return $span;
            });
            $(".edit-user-btn").css("display", "none");
            $(".display-user-btn").css("display", "block");
            return saveData;
        }

        function showError(show, msg) {
            if(show) {
                $("#errorMsg").css("display", "block");
                $("#errorMsg").text(msg);
                $("")
            } else {
                $("#errorMsg").css("display", "none");
            }
        }

        function processFind(err, res) {
            showError(false);
            $(".user-key-value-div").remove();
            $(".edit-user-btn").css("display", "none");
            $(".display-user-btn").css("display", "none");
            console.log(res)
            if (err) {
                showError(true, res.message);
            } else {
                if(res.event == "error") {
                    showError(true, res.message);
                } else {
                    showUser(res.data);
                }
            }
        }

        $(init);
        function init() {
            $("#shSubTitle").text("User Manager");

            showUser(Env.user);

            $("#findByEmail").click(function() {
                var email = $("#email").val();
                shCall({cmd: "user.find", by: "email", value: email}, processFind);
            });
            $("#findByUid").click(function() {
                var uid = $("#uid").val();
                shCall({cmd: "user.find", by: "uid", value: uid}, processFind);
            });
            $("#findByToken").click(function() {
                var token = $("#token").val();
                shCall({cmd: "user.find", by: "token", value: token}, processFind);
            });

            $("#editUserBtn").click(function() {
                editCurrent();
            });
            $("#saveUserBtn").click(function() {
                var saveData = resetCurrent(true);
                var res = shCall({cmd: "user.aset", uid: Env.user.oid, user: saveData}, function (error, data) {
                    console.log(error, data);
                });
            });
            $("#cancelUserBtn").click(function() {
                resetCurrent(false);
            });
        }
    </script>

</head>
<body>
{{> header}}
{{> adminNav}}

<div class="gameBoxDiv lookupUserDiv">
    <div class="gameBoxHeaderDiv">Lookup User</div>
    <div class="gameBoxInnerDiv">
        <table>
            <tr><td>By Email:</td><td><input id="email" class="emailInput" type="text"></input></td><td><button id="findByEmail">find</button></td></tr>
            <tr><td>By Uid:</td><td><input id="uid" class="uidInput" type="text" value=""></input></td><td><button id="findByUid">find</button></td></tr>
            <tr><td>By Token:</td><td><input id="token" class="tokenInput" type="text" value=""></input></td><td><button id="findByToken">find</button></td></tr>
        </table>
    </div>
</div>
<div style="clear:both;"></div>
<div id="errorMsg"></div>
<div id="userEditor">
    <div id="keyValueTpl" style="display:none"><span id="key">key</span> = <span id="value">value</span></div>
</div>
<div class="btn-div">
    <button id="editUserBtn" class="display-user-btn">Edit</button>
    <button id="saveUserBtn" class="edit-user-btn">Save</button>
    <button id="cancelUserBtn" class="edit-user-btn">Cancel</button>
</div>

{{> footer}}
</body>
</html>